
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>QUnit Example</title>
<script src="dep.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-1.23.0.css">
<script>
    var baseUrl = "http:\/\/115.28.134.156:3000\/";
</script>
<script src="https://code.jquery.com/qunit/qunit-1.23.0.js"></script>
<script src="msg.en.js"></script>
<script src="../public/data/localForage-1.4.0/dist/localforage.js"></script>
<script src="alldata5.js"></script>
<script>
    var LEA = {};
    LEA.sPath = "https:\/\/dn-leanote.qbox.me";
    LEA.locale = "en";
    var UrlPrefix = 'http:\/\/leanote.com';
    var GlobalConfigs = {"uploadAttachSize":0,"uploadAvatarSize":0,"uploadBlogLogoSize":0,"uploadImageSize":0};
//    var tinyMCEPreInit = {base: 'https:\/\/dn-leanote.qbox.me/tinymce_4.1.9/js/tinymce', suffix: '.min'};
    var curNoteId = "";
    var curNotebookId = "";
    var curSharedNoteNotebookId = "";
    var curSharedUserId = "";
    var noteContentJson = [];

    //需要同步的初始数据
    var UserInfo = {"UserId":"","Email":"me@nottingham.edu.cn","Verified":false,"Username":"unknown","UsernameRaw":"","CreatedTime":"0001-01-01T00:00:00Z","Logo":"http://leanote.com/images/blog/default_avatar.png","Theme":"","NotebookWidth":0,"NoteListWidth":0,"MdEditorWidth":0,"LeftIsMin":false,"ThirdUserId":"","ThirdUsername":"","ThirdType":0,"FromUserId":"","NoteCnt":0,"Usn":10,"FullSyncBefore":"0001-01-01T00:00:00Z","BlogUrl":"","PostUrl":"", "Password":"unknown"};

    var notebooks = [];

    var shareNotebooks = {};
    
    var sharedUserInfos = [];
    
    var shareNotebookDefault = {};

    var notes = [];

    var latestNotes = [];

    var tagsJson = [];

    var trackingLog = [];
    
    var allAppData = {};
    
    //initial data    
    allAppData.UserInfo = UserInfo;
    allAppData.notebooks = notebooks;
    allAppData.shareNotebooks = shareNotebooks;
    allAppData.sharedUserInfos = sharedUserInfos;
    allAppData.notes = notes;
    allAppData.latestNotes = latestNotes;
    allAppData.tagsJson = tagsJson;
    allAppData.trackingLog = trackingLog;
    allAppData.shareNotebookDefault = shareNotebookDefault;
</script>
<script src="app.min.js"></script>


<style>body { width: 500px; margin-left: auto; margin-right: auto; background-color: #f0f3f9; }</style>
<script type="text/javascript">
	
</script>

<script type="text/javascript">
	
    function sleep(miliseconds) {
       var currentTime = new Date().getTime();

       while (currentTime + miliseconds >= new Date().getTime()) {
       }
    }
    
    var baseUrl = "http:\/\/115.28.134.156:3000\/";
    
</script>   

<script>
test("Save into local storage", function(assert) {
    var done = assert.async();
    
    localforage.clear();
    sleep(500);
    
//    there are two notebooks
    Notebook.doAddNotebook("Notebook1", "testNotebook1", "");
    Notebook.doAddNotebook("-1", "trash", "");
    
    ok(2 == Object.getOwnPropertyNames(Notebook.cache).length, "2 notebooks created successfully");
    ok("testNotebook1" == Notebook.cache["Notebook1"].Title, "2 notebooks created successfully");
    ok("trash" == Notebook.cache["-1"].Title, "2 notebooks created successfully");
    
//    there are 2 notes
    Note.newNote("Notebook1");
    Note.newNote("Notebook1");
    ok(2 == Object.getOwnPropertyNames(Note.cache).length, "2 notes created successfully");

//    there are 1 tag
    var newTag = {
        Count: 1,
        CreatedTime: getCurDate(),
        IsDeleted: false,
        Tag: "Red",
        TagId: "testTag1",
        UpdatedTime: getCurDate(),
        UserId: "",
        Usn: 94
    };
    Tag.addTagNav(newTag);
    ok(1 == Tag.tags.length, "1 tag created successfully!");
    Tag.renderTagNav(Tag.tags);
    
    saveIntoLocal();
    
    localforage.getItem('allAppData', function(err, value) {
        if(value != null) { //如果本地有数据，使用本地的
            allAppData = value;
            UserInfo = allAppData.UserInfo;
            notebooks = allAppData.notebooks;
            shareNotebooks = allAppData.shareNotebooks;
            sharedUserInfos = allAppData.sharedUserInfos;
            notes = allAppData.notes;
            latestNotes = allAppData.latestNotes;
            tagsJson = allAppData.tagsJson;
            trackingLog = allAppData.trackingLog;
            shareNotebookDefault = allAppData.shareNotebookDefault;

            ok(2 == notebooks.length, "Notebooks in the local storage are right");
            ok(2 == notes.length, "Notes in the local storage are right");
            ok(1 == tagsJson.length, "Tags in the local storage are right");
            done();
        }
        else {
            ok(0, "error");
            done();
        }
    });
});

test("Server side: Log in", function(assert) {
    var done = assert.async();
    var done1 = assert.async();
    var done2 = assert.async();

    var Email = "whiteBoxTester";
    var inexistentEmai = "inexistent";
    var correctPassword = "";
    var incorrectPassword = "wrong";
    var correctJsonData = {"Email": Email, "Password": correctPassword}; 
    var incorrectJsonData1= {"Email": Email, "Password": incorrectPassword}; // right email but wrong password
    var incorrectJsonData2= {"Email": inexistentEmai, "Password": correctPassword}; // wrong email but right password
    var correctUserId = "570b56f8d922a8399d000000";
    var stringifiedJson = JSON.stringify(correctJsonData);
    var incorrectStringifiedJson1 = JSON.stringify(incorrectJsonData1);
    var incorrectStringifiedJson2 = JSON.stringify(incorrectJsonData2);
    var url = baseUrl + 'logIn';

    $.ajax({
        type: 'POST',
        url: url,
        data: stringifiedJson,
        contentType: "text/plain",
        success: function (data) {
            var res = jQuery.parseJSON(data);
            if(res.status == "fail") {
                ok(0, "Log in successfully, UserId is correct");
                done();
            }
            else {
                localStorage.UserId = res.UserId;
                UserId = res.UserId;
                ok(correctUserId == res.UserId, "Log in successfully and returned UserId is correct")
                done();
            }
        },
        error: function (xhr, status, error) {
            ok(0, "Log in successfully, UserId is correct");
            done();
        }
    });
    
    $.ajax({
        type: 'POST',
        url: url,
        data: incorrectStringifiedJson1,
        contentType: "text/plain",
        success: function (data) {
            var res = jQuery.parseJSON(data);
            if(res.status == "fail") {
                ok("wrong password" == res.msg, "Log in faid because of the wrong password");
                done1();
            }
            else {
                localStorage.UserId = res.UserId;
                ok(0, "Log in faid because of the wrong password");
                done1();
            }
        },
        error: function (xhr, status, error) {
            ok(0, "Log in successfully, UserId is correct");
            done1();
        }
    });
    
    $.ajax({
        type: 'POST',
        url: url,
        data: incorrectStringifiedJson2,
        contentType: "text/plain",
        success: function (data) {
            var res = jQuery.parseJSON(data);
            if(res.status == "fail") {
                ok("wrong email" == res.msg, "Log in faid because of the inexistent email");
                done2();
            }
            else {
                localStorage.UserId = res.UserId;
                ok(0, "Log in faid because of the inexistent email");
                done2();
            }
        },
        error: function (xhr, status, error) {
            ok(0, "Log in faid because of the inexistent email");
            done2();
        }
    });
});
    
test("Server side: retrieve user data", function(assert) {
    var done = assert.async();
    
    var result = retrieveData();
    done();
    ok(2 == result, "Data is retrieved from the server successfully");
    
});
</script>
</head>

<body>
<div id="qunit"></div>
 <div id="qunit-fixture"></div>
</body>
</html>
